# Blueshift æ‰˜ç®¡ç³»ç»Ÿ - å®Œæ•´ä¸šåŠ¡æµç¨‹æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [å‚ä¸è€…è§’è‰²](#å‚ä¸è€…è§’è‰²)
- [è´¦æˆ·ç»“æ„](#è´¦æˆ·ç»“æ„)
- [å®Œæ•´äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ](#å®Œæ•´äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ)
- [çŠ¶æ€è½¬æ¢å›¾](#çŠ¶æ€è½¬æ¢å›¾)
- [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
- [ä»£ç æ¶æ„å¯¹æ¯”](#ä»£ç æ¶æ„å¯¹æ¯”)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)

---

## ç³»ç»Ÿæ¦‚è¿°

### ä»€ä¹ˆæ˜¯æ‰˜ç®¡ç³»ç»Ÿï¼Ÿ

æ‰˜ç®¡ï¼ˆEscrowï¼‰ç³»ç»Ÿæ˜¯ä¸€ä¸ª**æ— éœ€ä¿¡ä»»çš„ä»£å¸äº¤æ¢åè®®**ï¼Œå…è®¸åŒæ–¹åœ¨ä¸ç›¸äº’ä¿¡ä»»çš„æƒ…å†µä¸‹å®‰å…¨åœ°äº¤æ¢ä»£å¸ã€‚

### æ ¸å¿ƒä»·å€¼

- âœ… **æ— éœ€ä¿¡ä»»**ï¼šä¸éœ€è¦ç¬¬ä¸‰æ–¹ä¸­ä»‹
- âœ… **åŸå­æ€§**ï¼šäº¤æ˜“è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… **å®‰å…¨æ€§**ï¼šåŸºäº Solana çš„ PDA æœºåˆ¶
- âœ… **çµæ´»æ€§**ï¼šéšæ—¶å¯ä»¥å–æ¶ˆå¹¶å–å›ä»£å¸

### ä¸‰å¤§æ ¸å¿ƒæ“ä½œ

1. **Makeï¼ˆåˆ›å»ºï¼‰**ï¼šåˆ›å»ºè€…å­˜å…¥ä»£å¸ Aï¼ŒæŒ‡å®šæœŸæœ›è·å¾—çš„ä»£å¸ B æ•°é‡
2. **Takeï¼ˆæ¥å—ï¼‰**ï¼šæ¥å—è€…å‘é€ä»£å¸ Bï¼Œè·å¾—é‡‘åº“ä¸­çš„ä»£å¸ A
3. **Refundï¼ˆé€€æ¬¾ï¼‰**ï¼šåˆ›å»ºè€…å–æ¶ˆæ‰˜ç®¡ï¼Œå–å›å­˜å…¥çš„ä»£å¸ A

---

## æ ¸å¿ƒæ¦‚å¿µ

### PDAï¼ˆç¨‹åºæ´¾ç”Ÿåœ°å€ï¼‰

**PDA** æ˜¯ç”±ç¨‹åº ID å’Œç§å­ï¼ˆseedsï¼‰æ´¾ç”Ÿå‡ºçš„ç‰¹æ®Šåœ°å€ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

```
PDA = ProgramDerivedAddress(
    seeds: ["escrow", maker_pubkey, random_seed],
    program_id: escrow_program_id
)
```

**å…³é”®ç‰¹æ€§ï¼š**
- ğŸ“Œ æ²¡æœ‰å¯¹åº”çš„ç§é’¥ï¼ˆæ— æ³•è¢«æ™®é€šç”¨æˆ·ç­¾åï¼‰
- ğŸ“Œ åªèƒ½ç”±åˆ›å»ºå®ƒçš„ç¨‹åºç­¾åä½¿ç”¨
- ğŸ“Œ ç¡®ä¿åªæœ‰æœ¬ç¨‹åºèƒ½æ§åˆ¶æ‰˜ç®¡è´¦æˆ·å’Œé‡‘åº“

**åœ¨æœ¬é¡¹ç›®ä¸­çš„åº”ç”¨ï¼š**

| è´¦æˆ· | æ´¾ç”Ÿç§å­ | ç”¨é€” |
|------|---------|------|
| `escrow` æ‰˜ç®¡è´¦æˆ· | `["escrow", maker, seed]` | å­˜å‚¨äº¤æ˜“çŠ¶æ€ |
| `vault` é‡‘åº“è´¦æˆ· | `[taker, token_program, mint_a]` | å­˜å‚¨ä»£å¸ Aï¼ˆATAï¼‰|

### ATAï¼ˆå…³è”ä»£å¸è´¦æˆ·ï¼‰

**ATA** æ˜¯ Solana ä¸­ç”¨äºå­˜å‚¨ SPL Token çš„æ ‡å‡†è´¦æˆ·ï¼Œåœ°å€ç”±ä»¥ä¸‹å†³å®šï¼š

```rust
ATA åœ°å€ = PDA(
    seeds: [owner_address, token_program_address, mint_address],
    program_id: associated_token_program_id
)
```

**æœ¬é¡¹ç›®ä¸­çš„ ATAï¼š**

| ATA è´¦æˆ· | æ‹¥æœ‰è€… | ä»£å¸ç±»å‹ | ç”¨é€” |
|---------|--------|---------|------|
| `maker_ata_a` | åˆ›å»ºè€… | ä»£å¸ A | åˆ›å»ºè€…å­˜å…¥ä»£å¸çš„è´¦æˆ· |
| `vault` | escrow PDA | ä»£å¸ A | é‡‘åº“ï¼Œå­˜å‚¨è¢«æ‰˜ç®¡çš„ä»£å¸ |
| `taker_ata_a` | æ¥å—è€… | ä»£å¸ A | æ¥å—è€…æ¥æ”¶ä»£å¸çš„è´¦æˆ· |
| `taker_ata_b` | æ¥å—è€… | ä»£å¸ B | æ¥å—è€…æ”¯ä»˜ä»£å¸çš„è´¦æˆ· |
| `maker_ata_b` | åˆ›å»ºè€… | ä»£å¸ B | åˆ›å»ºè€…æ¥æ”¶ä»£å¸çš„è´¦æˆ· |

---

## å‚ä¸è€…è§’è‰²

### åˆ›å»ºè€…ï¼ˆMakerï¼‰

**å®šä¹‰ï¼š** å‘èµ·æ‰˜ç®¡äº¤æ˜“çš„ä¸€æ–¹

**æƒåˆ©ï¼š**
- å­˜å…¥ä»£å¸ A åˆ°é‡‘åº“
- æŒ‡å®šæœŸæœ›è·å¾—çš„ä»£å¸ B æ•°é‡
- éšæ—¶å¯ä»¥å–æ¶ˆæ‰˜ç®¡å¹¶å–å›ä»£å¸
- äº¤æ˜“å®Œæˆåæ¥æ”¶ä»£å¸ B

**ä¹‰åŠ¡ï¼š**
- ä¸ºåˆ›å»ºè´¦æˆ·æ”¯ä»˜ç§Ÿé‡‘ï¼ˆlamportsï¼‰
- å¯¹é‡‘åº“å­˜æ¬¾æ“ä½œç­¾å

### æ¥å—è€…ï¼ˆTakerï¼‰

**å®šä¹‰ï¼š** æ¥å—æ‰˜ç®¡äº¤æ˜“çš„ä¸€æ–¹

**æƒåˆ©ï¼š**
- æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ‰˜ç®¡äº¤æ˜“
- é€‰æ‹©æ¥å—æŸä¸ªæ‰˜ç®¡äº¤æ˜“
- äº¤æ˜“å®Œæˆåè·å¾—ä»£å¸ A

**ä¹‰åŠ¡ï¼š**
- å‘åˆ›å»ºè€…æ”¯ä»˜æŒ‡å®šæ•°é‡çš„ä»£å¸ B
- ä¸ºå¯èƒ½éœ€è¦åˆ›å»ºçš„ ATA æ”¯ä»˜ç§Ÿé‡‘

### å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Make         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºè€…      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚  æ‰˜ç®¡è´¦æˆ·    â”‚
â”‚  (Maker)     â”‚   å­˜å…¥ Token A       â”‚  (Escrow)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                   â”‚
      â”‚                                   â”‚ Take
      â”‚                                   â”‚
      â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                          â”‚   é‡‘åº“è´¦æˆ·       â”‚
      â”‚                          â”‚   (Vault)        â”‚
      â”‚                          â”‚  å­˜å‚¨ Token A    â”‚
      â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ Refund
      â”‚
      â”‚ è¿”å› Token A
      â”‚
   â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  åˆ›å»ºè€…      â”‚
   â”‚  å–å›ä»£å¸    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Take       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å—è€…      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚  åˆ›å»ºè€…      â”‚
â”‚  (Taker)     â”‚   æ”¯ä»˜ Token B       â”‚  (Maker)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚
      â”‚ è·å¾— Token A
      â”‚
   â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  æ¥å—è€…      â”‚
   â”‚  è·å¾—ä»£å¸    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è´¦æˆ·ç»“æ„

### Escrow æ‰˜ç®¡è´¦æˆ·

**å­˜å‚¨ä½ç½®ï¼š** é“¾ä¸Šç¨‹åºæ‹¥æœ‰è´¦æˆ·

**æ•°æ®ç»“æ„ï¼š**
```rust
pub struct Escrow {
    pub seed: u64,        // éšæœºç§å­ï¼Œç”¨äº PDA æ´¾ç”Ÿ
    pub maker: Address,   // åˆ›å»ºè€…åœ°å€
    pub mint_a: Address,  // è¢«å­˜å…¥çš„ä»£å¸ mint
    pub mint_b: Address,  // è¯·æ±‚çš„ä»£å¸ mint
    pub receive: u64,     // è¯·æ±‚çš„ä»£å¸ B æ•°é‡
    pub bump: [u8; 1],    // PDA bump ç§å­
}
```

**å¤§å°ï¼š** 113 å­—èŠ‚ï¼ˆ8 + 32 + 32 + 32 + 8 + 1ï¼‰

**ç”Ÿå‘½å‘¨æœŸï¼š**
- åˆ›å»ºæ—¶ï¼šMake æŒ‡ä»¤åˆ›å»º
- æ´»è·ƒæœŸï¼šå­˜å‚¨åœ¨é“¾ä¸Šï¼Œç­‰å¾…è¢« Take æˆ– Refund
- å…³é—­æ—¶ï¼šTake æˆ– Refund æŒ‡ä»¤å…³é—­ï¼Œç§Ÿé‡‘è¿”è¿˜ç»™åˆ›å»ºè€…

### è´¦æˆ·å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‰˜ç®¡ç”Ÿæ€ç³»ç»Ÿ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  åˆ›å»ºè€…è´¦æˆ·   â”‚         â”‚  æ¥å—è€…è´¦æˆ·   â”‚              â”‚
â”‚  â”‚  (System)    â”‚         â”‚  (System)    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â”‚                        â”‚                      â”‚
â”‚          â”‚ owner                 â”‚ owner               â”‚
â”‚          â–¼                        â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ maker_ata_a  â”‚         â”‚ taker_ata_a  â”‚              â”‚
â”‚  â”‚ maker_ata_b  â”‚         â”‚ taker_ata_b  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚          â–²                        â–²                      â”‚
â”‚          â”‚                        â”‚                      â”‚
â”‚          â”‚ has_one                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚            Escrow æ‰˜ç®¡è´¦æˆ· (PDA)            â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚  â”‚  â”‚ seed, maker, mint_a, mint_b,         â”‚  â”‚         â”‚
â”‚  â”‚  â”‚ receive, bump                         â”‚  â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                      â”‚ authority                          â”‚
â”‚                      â–¼                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚              â”‚  é‡‘åº“è´¦æˆ·     â”‚                             â”‚
â”‚              â”‚   (Vault)    â”‚                             â”‚
â”‚              â”‚  å­˜å‚¨ Token A â”‚                             â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ

### é˜¶æ®µ 1: Makeï¼ˆåˆ›å»ºæ‰˜ç®¡äº¤æ˜“ï¼‰

#### ğŸ“ ä¸šåŠ¡ç›®æ ‡

åˆ›å»ºè€…æƒ³è¦ç”¨ **Token A** äº¤æ¢ **Token B**ï¼Œå­˜å…¥ Token A åˆ°é‡‘åº“ï¼Œç­‰å¾…å…¶ä»–äººæ¥å—ã€‚

#### ğŸ”„ æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åˆ›å»ºè€…å‘èµ· Make äº¤æ˜“                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  è¾“å…¥å‚æ•°ï¼š                                               â”‚
â”‚  - seed: éšæœºæ•°ï¼ˆç”¨äºç”Ÿæˆå”¯ä¸€ PDAï¼‰                        â”‚
â”‚  - receive: æœŸæœ›è·å¾—çš„ Token B æ•°é‡                       â”‚
â”‚  - amount: å®é™…å­˜å…¥çš„ Token A æ•°é‡                        â”‚
â”‚                                                          â”‚
â”‚  æ‰§è¡Œæ­¥éª¤ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: åˆ›å»ºæ‰˜ç®¡è´¦æˆ· (Escrow PDA)                  â”‚   â”‚
â”‚  â”‚ - è®¡ç®— PDA: ["escrow", maker, seed]              â”‚   â”‚
â”‚  â”‚ - åˆ›å»ºè´¦æˆ·ï¼Œåˆ†é… 113 å­—èŠ‚æ•°æ®ç©ºé—´                 â”‚   â”‚
â”‚  â”‚ - åˆå§‹åŒ–æ‰˜ç®¡æ•°æ®ç»“æ„                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: åˆ›å»ºé‡‘åº“è´¦æˆ· (Vault ATA)                   â”‚   â”‚
â”‚  â”‚ - ATA åœ°å€: PDA([escrow, token_program, mint_a])  â”‚   â”‚
â”‚  â”‚ - authority: escrow PDA (ç”±ç¨‹åºæ§åˆ¶)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: å­˜å…¥ä»£å¸åˆ°é‡‘åº“                             â”‚   â”‚
â”‚  â”‚ - ä»: maker_ata_a                                â”‚   â”‚
â”‚  â”‚ - åˆ°: vault                                       â”‚   â”‚
â”‚  â”‚ - æ•°é‡: amount                                    â”‚   â”‚
â”‚  â”‚ - æƒé™: maker ç­¾å                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  ç»“æœï¼š                                                  â”‚
â”‚  âœ… æ‰˜ç®¡è´¦æˆ·åˆ›å»ºå¹¶åˆå§‹åŒ–                                 â”‚
â”‚  âœ… é‡‘åº“è´¦æˆ·åˆ›å»ºå¹¶æ¥æ”¶ä»£å¸                               â”‚
â”‚  âœ… åˆ›å»ºè€…çš„ Token A è¢«é”å®š                               â”‚
â”‚  âŒ æ‰˜ç®¡äº¤æ˜“å¤„äº"å¾…æ¥å—"çŠ¶æ€                             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“Š çŠ¶æ€å˜åŒ–

```
[æ‰˜ç®¡åˆ›å»ºå‰]
maker: æ‹¥æœ‰ 1000 Token A
escrow: ä¸å­˜åœ¨
vault: ä¸å­˜åœ¨

      â†“ Make æŒ‡ä»¤

[æ‰˜ç®¡åˆ›å»ºå]
maker: æ‹¥æœ‰ 1000 - N Token A  (N = amount)
escrow: å­˜åœ¨äºé“¾ä¸Šï¼Œæ•°æ®å·²åˆå§‹åŒ–
vault: æ‹¥æœ‰ N Token Aï¼Œç”± escrow PDA æ§åˆ¶
```

#### ğŸ” å®‰å…¨ä¿éšœ

1. **PDA æ§åˆ¶**ï¼šé‡‘åº“ç”± escrow PDA æ‹¥æœ‰ï¼Œåªæœ‰æœ¬ç¨‹åºèƒ½è½¬å‡ºä»£å¸
2. **ç§Ÿé‡‘è±å…**ï¼šæ‰˜ç®¡è´¦æˆ·æœ‰è¶³å¤Ÿçš„ lamportsï¼Œä¸ä¼šè¢«åƒåœ¾å›æ”¶
3. **ç­¾åéªŒè¯**ï¼šåˆ›å»ºè€…å¿…é¡»ç­¾åï¼Œæˆæƒä»£å¸è½¬è´¦

---

### é˜¶æ®µ 2: Takeï¼ˆæ¥å—æ‰˜ç®¡äº¤æ˜“ï¼‰

#### ğŸ“ ä¸šåŠ¡ç›®æ ‡

æ¥å—è€…åŒæ„åˆ›å»ºè€…çš„æŠ¥ä»·ï¼Œå‘é€ **Token B** ç»™åˆ›å»ºè€…ï¼Œä»é‡‘åº“ä¸­è·å¾— **Token A**ã€‚

#### ğŸ”„ æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ¥å—è€…å‘èµ· Take äº¤æ˜“                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  éªŒè¯æ¡ä»¶ï¼š                                               â”‚
â”‚  - æ‰˜ç®¡è´¦æˆ·å­˜åœ¨ä¸”æœ‰æ•ˆ                                     â”‚
â”‚  - æ¥å—è€…æœ‰è¶³å¤Ÿçš„ Token B                                â”‚
â”‚  - escrow.maker == maker (éªŒè¯åˆ›å»ºè€…)                    â”‚
â”‚  - escrow.mint_a == mint_a (éªŒè¯ä»£å¸ç±»å‹)                â”‚
â”‚  - escrow.mint_b == mint_b (éªŒè¯ä»£å¸ç±»å‹)                â”‚
â”‚                                                          â”‚
â”‚  æ‰§è¡Œæ­¥éª¤ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: ä»é‡‘åº“è½¬ç§» Token A ç»™æ¥å—è€…                 â”‚   â”‚
â”‚  â”‚ - ä»: vault                                       â”‚   â”‚
â”‚  â”‚ - åˆ°: taker_ata_a                                 â”‚   â”‚
â”‚  â”‚ - æ•°é‡: vault.amount (é‡‘åº“ä¸­çš„å…¨éƒ¨ä»£å¸)           â”‚   â”‚
â”‚  â”‚ - æƒé™: escrow PDA ç­¾å                            â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“Œ ä½¿ç”¨ invoke_signed æä¾› PDA ç­¾å                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: å…³é—­é‡‘åº“è´¦æˆ·                               â”‚   â”‚
â”‚  â”‚ - éªŒè¯é‡‘åº“ä½™é¢ä¸º 0 (ä»£å¸å·²å…¨éƒ¨è½¬å‡º)                â”‚   â”‚
â”‚  â”‚ - å°†é‡‘åº“çš„ lamports è½¬ç»™ maker                     â”‚   â”‚
â”‚  â”‚ - æ¸…é›¶è´¦æˆ·æ•°æ®                                     â”‚   â”‚
â”‚  â”‚ - æƒé™: escrow PDA ç­¾å                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: ä»æ¥å—è€…è½¬ç§» Token B ç»™åˆ›å»ºè€…               â”‚   â”‚
â”‚  â”‚ - ä»: taker_ata_b                                 â”‚   â”‚
â”‚  â”‚ - åˆ°: maker_ata_b                                 â”‚   â”‚
â”‚  â”‚ - æ•°é‡: escrow.receive (æ‰˜ç®¡ä¸­è®°å½•çš„æœŸæœ›æ•°é‡)      â”‚   â”‚
â”‚  â”‚ - æƒé™: taker ç­¾å                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 4: å…³é—­æ‰˜ç®¡è´¦æˆ·                               â”‚   â”‚
â”‚  â”‚ - å°†æ‰˜ç®¡è´¦æˆ·çš„ç§Ÿé‡‘ï¼ˆlamportsï¼‰è¿”è¿˜ç»™ maker         â”‚   â”‚
â”‚  â”‚ - æ¸…é›¶è´¦æˆ·æ•°æ®                                     â”‚   â”‚
â”‚  â”‚ - è´¦æˆ·å¯è¢«é‡æ–°åˆ†é…                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  ç»“æœï¼š                                                  â”‚
â”‚  âœ… æ¥å—è€…è·å¾— Token A                                   â”‚
â”‚  âœ… åˆ›å»ºè€…è·å¾— Token B                                   â”‚
â”‚  âœ… é‡‘åº“è´¦æˆ·å·²å…³é—­ï¼Œlamports è¿”è¿˜ç»™åˆ›å»ºè€…                â”‚
â”‚  âœ… æ‰˜ç®¡è´¦æˆ·å·²å…³é—­ï¼Œç§Ÿé‡‘è¿”è¿˜ç»™åˆ›å»ºè€…                     â”‚
â”‚  âœ… æ‰˜ç®¡äº¤æ˜“å®Œæˆï¼Œæ— æ³•å†æ¬¡æ“ä½œ                           â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“Š çŠ¶æ€å˜åŒ–

```
[æ¥å—äº¤æ˜“å‰]
taker: æ‹¥æœ‰ 1000 Token B
maker: æ‹¥æœ‰ M Token A (å·²å­˜å…¥ N ä¸ªåˆ°é‡‘åº“)
vault: æ‹¥æœ‰ N Token A

      â†“ Take æŒ‡ä»¤

[æ¥å—äº¤æ˜“å]
taker: æ‹¥æœ‰ 1000 - R Token B, è·å¾— N Token A  (R = receive)
maker: æ‹¥æœ‰ M + R Token B
vault: å·²å…³é—­ï¼Œlamports è¿”è¿˜ç»™ maker
escrow: å·²å…³é—­ï¼Œç§Ÿé‡‘è¿”è¿˜ç»™ maker
```

#### ğŸ” å®‰å…¨ä¿éšœ

1. **åŸå­æ€§**ï¼šæ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªäº¤æ˜“ä¸­ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
2. **PDA éªŒè¯**ï¼šéªŒè¯æ‰˜ç®¡è´¦æˆ·ç¡®å®æ˜¯ä½¿ç”¨æ­£ç¡®çš„ç§å­æ´¾ç”Ÿ
3. **has_one çº¦æŸ**ï¼šç¡®ä¿ä¼ å…¥çš„è´¦æˆ·ä¸æ‰˜ç®¡æ•°æ®åŒ¹é…
4. **é¡ºåºæ‰§è¡Œ**ï¼šå…ˆè½¬å‡º Token Aï¼Œå†è½¬å…¥ Token Bï¼ˆPinocchio ç‰ˆæœ¬ï¼‰

#### âš ï¸ æ‰§è¡Œé¡ºåºè¯´æ˜

**Anchor ç‰ˆæœ¬ï¼š**
```rust
transfer_to_maker();      // å…ˆè½¬ Token B
withdraw_and_close_vault(); // å†è½¬ Token A
```

**Pinocchio ç‰ˆæœ¬ï¼š**
```rust
withdraw_and_close_vault(); // å…ˆè½¬ Token A
transfer_to_maker();        // å†è½¬ Token B
```

**åŸå› ï¼š** Pinocchio éœ€è¦åœ¨ CPI å‰é‡Šæ”¾å€Ÿç”¨ï¼Œé€šè¿‡ä»£ç å—ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚

---

### é˜¶æ®µ 3: Refundï¼ˆå–æ¶ˆæ‰˜ç®¡äº¤æ˜“ï¼‰

#### ğŸ“ ä¸šåŠ¡ç›®æ ‡

åˆ›å»ºè€…æ”¹å˜ä¸»æ„æˆ–æ— äººæ¥å—æ‰˜ç®¡ï¼Œå–æ¶ˆæ‰˜ç®¡å¹¶å–å›å­˜å…¥çš„ Token Aã€‚

#### ğŸ”„ æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åˆ›å»ºè€…å‘èµ· Refund äº¤æ˜“                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  éªŒè¯æ¡ä»¶ï¼š                                               â”‚
â”‚  - æ‰˜ç®¡è´¦æˆ·å­˜åœ¨ä¸”æœ‰æ•ˆ                                     â”‚
â”‚  - è°ƒç”¨è€…æ˜¯åˆ›å»ºè€…ï¼ˆmaker å¿…é¡»ç­¾åï¼‰                       â”‚
â”‚  - escrow.maker == maker (éªŒè¯èº«ä»½)                      â”‚
â”‚  - escrow.mint_a == mint_a (éªŒè¯ä»£å¸ç±»å‹)                â”‚
â”‚                                                          â”‚
â”‚  æ‰§è¡Œæ­¥éª¤ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: ä»é‡‘åº“è½¬ç§» Token A å›åˆ›å»ºè€…                 â”‚   â”‚
â”‚  â”‚ - ä»: vault                                       â”‚   â”‚
â”‚  â”‚ - åˆ°: maker_ata_a                                 â”‚   â”‚
â”‚  â”‚ - æ•°é‡: vault.amount (é‡‘åº“ä¸­çš„å…¨éƒ¨ä»£å¸)           â”‚   â”‚
â”‚  â”‚ - æƒé™: escrow PDA ç­¾å                            â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“Œ ä½¿ç”¨ invoke_signed æä¾› PDA ç­¾å                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: å…³é—­é‡‘åº“è´¦æˆ·                               â”‚   â”‚
â”‚  â”‚ - éªŒè¯é‡‘åº“ä½™é¢ä¸º 0 (ä»£å¸å·²å…¨éƒ¨è½¬å‡º)                â”‚   â”‚
â”‚  â”‚ - å°†é‡‘åº“çš„ lamports è½¬ç»™ maker                     â”‚   â”‚
â”‚  â”‚ - æ¸…é›¶è´¦æˆ·æ•°æ®                                     â”‚   â”‚
â”‚  â”‚ - æƒé™: escrow PDA ç­¾å                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: å…³é—­æ‰˜ç®¡è´¦æˆ·                               â”‚   â”‚
â”‚  â”‚ - å°†æ‰˜ç®¡è´¦æˆ·çš„ç§Ÿé‡‘ï¼ˆlamportsï¼‰è¿”è¿˜ç»™ maker         â”‚   â”‚
â”‚  â”‚ - æ¸…é›¶è´¦æˆ·æ•°æ®                                     â”‚   â”‚
â”‚  â”‚ - è´¦æˆ·å¯è¢«é‡æ–°åˆ†é…                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  ç»“æœï¼š                                                  â”‚
â”‚  âœ… åˆ›å»ºè€…å–å› Token A                                   â”‚
â”‚  âœ… é‡‘åº“è´¦æˆ·å·²å…³é—­ï¼Œlamports è¿”è¿˜ç»™åˆ›å»ºè€…                â”‚
â”‚  âœ… æ‰˜ç®¡è´¦æˆ·å·²å…³é—­ï¼Œç§Ÿé‡‘è¿”è¿˜ç»™åˆ›å»ºè€…                     â”‚
â”‚  âœ… æ‰˜ç®¡äº¤æ˜“å·²å–æ¶ˆï¼Œæ— æ³•å†æ¬¡æ“ä½œ                         â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“Š çŠ¶æ€å˜åŒ–

```
[é€€æ¬¾å‰]
maker: æ‹¥æœ‰ M Token A (å·²å­˜å…¥ N ä¸ªåˆ°é‡‘åº“)
vault: æ‹¥æœ‰ N Token A

      â†“ Refund æŒ‡ä»¤

[é€€æ¬¾å]
maker: æ‹¥æœ‰ M + N Token A (å…¨éƒ¨å–å›)
vault: å·²å…³é—­ï¼Œlamports è¿”è¿˜ç»™ maker
escrow: å·²å…³é—­ï¼Œç§Ÿé‡‘è¿”è¿˜ç»™ maker
```

#### ğŸ” å®‰å…¨ä¿éšœ

1. **ç­¾åéªŒè¯**ï¼šåªæœ‰åˆ›å»ºè€…èƒ½å‘èµ·é€€æ¬¾ï¼ˆ`SignerAccount::check`ï¼‰
2. **PDA éªŒè¯**ï¼šç¡®ä¿æ‰˜ç®¡è´¦æˆ·æœªè¢«ç¯¡æ”¹
3. **ç§Ÿé‡‘è¿”è¿˜**ï¼šåˆ›å»ºè€…å–å›æ‰€æœ‰èµ„é‡‘ï¼ŒåŒ…æ‹¬è´¦æˆ·ç§Ÿé‡‘

---

## çŠ¶æ€è½¬æ¢å›¾

### æ‰˜ç®¡äº¤æ˜“çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆå§‹çŠ¶æ€    â”‚
â”‚  (æ— æ‰˜ç®¡è´¦æˆ·)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Make (åˆ›å»ºæ‰˜ç®¡)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ´»è·ƒçŠ¶æ€     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (æ‰˜ç®¡è´¦æˆ·å­˜åœ¨)â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚                              â”‚
       â”‚                              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚              â”‚               â”‚
       â”‚ Take         â”‚ Refund        â”‚
       â”‚ (æ¥å—æ‰˜ç®¡)    â”‚ (å–æ¶ˆæ‰˜ç®¡)     â”‚
       â”‚              â”‚               â”‚
       â–¼              â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  å®ŒæˆçŠ¶æ€     â”‚ â”‚  å–æ¶ˆçŠ¶æ€     â”‚    â”‚
â”‚(ä»£å¸å·²äº¤æ¢)   â”‚ â”‚(ä»£å¸å·²é€€å›)   â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                      â”‚
                                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»ˆç»“çŠ¶æ€     â”‚
â”‚(è´¦æˆ·å·²å…³é—­)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èµ„é‡‘æµåŠ¨å›¾

```
                    Make æŒ‡ä»¤
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Maker   â”‚                   â”‚  Vault  â”‚
    â”‚  ATA A  â”‚ â”€â”€â”€â”€ Token A â”€â”€â”€â–¶â”‚   ATA   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚                   â”‚
                   Take â”‚                   â”‚ Refund
                        â”‚                   â”‚
                        â–¼                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Taker   â”‚         â”‚  Maker  â”‚
                    â”‚  ATA A  â”‚         â”‚  ATA A  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    Take æŒ‡ä»¤
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Taker   â”‚
    â”‚  ATA B  â”‚ â”€â”€â”€â”€ Token B â”€â”€â”€â–¶â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ Maker   â”‚
                                  â”‚  ATA B  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®‰å…¨æœºåˆ¶

### 1. PDA æƒé™æ§åˆ¶

**é—®é¢˜ï¼š** å¦‚ä½•ç¡®ä¿åªæœ‰æ‰˜ç®¡ç¨‹åºèƒ½æ§åˆ¶é‡‘åº“ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ PDA ä½œä¸ºé‡‘åº“çš„ authority

```rust
// é‡‘åº“ ATA çš„ authority æ˜¯ escrow PDA
vault = {
    owner: token_program,
    authority: escrow_pda,  // â† PDAï¼Œæ²¡æœ‰ç§é’¥
    mint: mint_a
}

// åªæœ‰æ‰˜ç®¡ç¨‹åºèƒ½ä½¿ç”¨ escrow PDA ç­¾å
Transfer {
    authority: escrow,  // â† PDA ç­¾å
}.invoke_signed(&[signer_seeds])?;
```

### 2. has_one çº¦æŸ

**é—®é¢˜ï¼š** å¦‚ä½•ç¡®ä¿ä¼ å…¥çš„è´¦æˆ·ä¸æ‰˜ç®¡æ•°æ®åŒ¹é…ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** Anchor çš„ `has_one` çº¦æŸ

```rust
#[account(
    has_one = maker @ EscrowError::InvalidMaker,
    has_one = mint_a @ EscrowError::InvalidMintA,
    has_one = mint_b @ EscrowError::InvalidMintB,
)]
pub escrow: Account<'info, Escrow>
```

**éªŒè¯é€»è¾‘ï¼š**
```rust
assert!(escrow.maker == maker.key());
assert!(escrow.mint_a == mint_a.key());
assert!(escrow.mint_b == mint_b.key());
```

### 3. åŸå­æ€§ä¿è¯

**é—®é¢˜ï¼š** å¦‚ä½•ç¡®ä¿äº¤æ˜“è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** Solana äº‹åŠ¡çš„åŸå­æ€§

```rust
// Take æŒ‡ä»¤ä¸­çš„åŸå­æ“ä½œ
pub fn process(&mut self) -> ProgramResult {
    transfer_A_to_taker()?;     // æ­¥éª¤ 1
    close_vault()?;             // æ­¥éª¤ 2
    transfer_B_to_maker()?;     // æ­¥éª¤ 3
    close_escrow()?;            // æ­¥éª¤ 4

    // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šå›æ»š
    Ok(())
}
```

### 4. é‡å¤æ“ä½œé˜²æŠ¤

**é—®é¢˜ï¼š** å¦‚ä½•é˜²æ­¢åŒä¸€ä¸ªæ‰˜ç®¡è¢«å¤šæ¬¡ Take æˆ– Refundï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** å…³é—­è´¦æˆ·

```rust
// Take æˆ– Refund å
close_account(escrow);  // â† è´¦æˆ·è¢«å…³é—­ï¼Œæ— æ³•å†æ¬¡æ“ä½œ

// å°è¯•å†æ¬¡æ“ä½œä¼šå¤±è´¥
// Error: Account already closed
```

### 5. ç§Ÿé‡‘è±å…

**é—®é¢˜ï¼š** å¦‚ä½•ç¡®ä¿è´¦æˆ·ä¸ä¼šè¢«åˆ é™¤ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** å­˜å‚¨è¶³å¤Ÿçš„ lamports

```rust
// åˆ›å»ºè´¦æˆ·æ—¶
let lamports = Rent::get()?.minimum_balance(space);

CreateAccount {
    from: payer,
    to: account,
    lamports,  // â† æ”¯ä»˜ç§Ÿé‡‘è±å…è´¹ç”¨
    space,
    owner: program_id,
}.invoke()?;
```

---

## ä»£ç æ¶æ„å¯¹æ¯”

### Anchor vs Pinocchio

| ç‰¹æ€§ | Anchor | Pinocchio |
|------|--------|-----------|
| **æŠ½è±¡çº§åˆ«** | é«˜çº§å® | æ‰‹åŠ¨å®ç° |
| **ä»£ç é‡** | è¾ƒå°‘ | è¾ƒå¤š |
| **æ€§èƒ½** | ä¸€èˆ¬ | ä¼˜ç§€ |
| **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ | é™¡å³­ |
| **çµæ´»æ€§** | å—é™ | å®Œå…¨æ§åˆ¶ |
| **åˆ¤åˆ«å™¨** | 8 å­—èŠ‚å“ˆå¸Œ | 1 å­—èŠ‚ |
| **ç±»å‹å®‰å…¨** | ç¼–è¯‘æ—¶æ£€æŸ¥ | ç¼–è¯‘æ—¶æ£€æŸ¥ |

### Anchor ä»£ç ç¤ºä¾‹

```rust
#[derive(Accounts)]
pub struct Make<'info> {
    #[account(mut)]
    pub maker: Signer<'info>,

    #[account(
        init,
        payer = maker,
        space = Escrow::INIT_SPACE + 8,
        seeds = [b"escrow", maker.key().as_ref(), seed.to_le_bytes().as_ref()],
        bump,
    )]
    pub escrow: Account<'info, Escrow>,

    #[account(
        init,
        payer = maker,
        associated_token::mint = mint_a,
        associated_token::authority = escrow,
    )]
    pub vault: InterfaceAccount<'info, TokenAccount>,
}

pub fn handler(ctx: Context<Make>, seed: u64, receive: u64, amount: u64) -> Result<()> {
    ctx.accounts.populate_escrow(seed, receive, ctx.bumps.escrow)?;
    ctx.accounts.deposit_token(amount)?;
    Ok(())
}
```

### Pinocchio ä»£ç ç¤ºä¾‹

```rust
pub struct MakeAccounts<'info> {
    pub maker: &'info AccountView,
    pub escrow: &'info AccountView,
    pub vault: &'info AccountView,
    // ... å…¶ä»–è´¦æˆ·
}

impl<'info> TryFrom<&'info [AccountView]> for MakeAccounts<'info> {
    fn try_from(accounts: &'info [AccountView]) -> Result<Self> {
        // æ‰‹åŠ¨éªŒè¯è´¦æˆ·
        SignerAccount::check(maker)?;
        MintInterface::check(mint_a)?;
        // ...
    }
}

pub fn process(&mut self) -> ProgramResult {
    // æ‰‹åŠ¨å®ç°æ‰€æœ‰é€»è¾‘
    let mut data = self.accounts.escrow.try_borrow_mut()?;
    let escrow = Escrow::load_mut(data.as_mut())?;
    escrow.set_inner(...);

    Transfer { ... }.invoke()?;
    Ok(())
}
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Alice      â”‚                  â”‚    Bob       â”‚
â”‚  æŒæœ‰ SOL     â”‚                  â”‚  æŒæœ‰ USDC    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                â”‚
       â”‚ 1. Alice åˆ›å»ºæ‰˜ç®¡               â”‚
       â”‚    - å­˜å…¥ 10 SOL                â”‚
       â”‚    - è¯·æ±‚ 200 USDC              â”‚
       â”‚                                â”‚
       â”‚                                â”‚ 2. Bob æ¥å—æ‰˜ç®¡
       â”‚                                â”‚    - æ”¯ä»˜ 200 USDC
       â”‚                                â”‚    - è·å¾— 10 SOL
       â”‚                                â”‚
       â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Alice      â”‚                  â”‚    Bob       â”‚
â”‚  æŒæœ‰ USDC    â”‚                  â”‚  æŒæœ‰ SOL     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 2: NFT äº¤æ˜“

```
åˆ›å»ºè€…: NFT æŒæœ‰è€…
æ¥å—è€…: ä¹°å®¶

æ‰˜ç®¡å†…å®¹:
- Token A: NFT (ä½¿ç”¨ Token Program çš„ NFT)
- Token B: SOL

æµç¨‹:
1. åˆ›å»ºè€…å­˜å…¥ NFT
2. ä¹°å®¶æ”¯ä»˜ SOL
3. ä¹°å®¶è·å¾— NFT
4. åˆ›å»ºè€…è·å¾— SOL
```

### åœºæ™¯ 3: é™æ—¶æŠ¥ä»·

```
åˆ›å»ºè€…åˆ›å»ºæ‰˜ç®¡åï¼Œå¯ä»¥è®¾ç½®æ—¶é—´é™åˆ¶ï¼š
- å¦‚æœåœ¨ X æ—¶é—´å†…æ— äººæ¥å—ï¼Œæ‰§è¡Œ Refund
- å¦‚æœæœ‰äººæ¥å—ï¼Œæ­£å¸¸æ‰§è¡Œ Take
- ç¡®ä¿èµ„é‡‘ä¸ä¼šæ°¸ä¹…é”å®š
```

### åœºæ™¯ 4: æ‰¹é‡äº¤æ˜“

```
åšå¸‚å•†å¯ä»¥ï¼š
1. åˆ›å»ºå¤šä¸ªæ‰˜ç®¡äº¤æ˜“ï¼ˆä¸åŒä»·æ ¼ï¼‰
2. ç­‰å¾…ç”¨æˆ·æ¥å—
3. è‡ªåŠ¨ç®¡ç†æµåŠ¨æ€§
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ— éœ€ä¿¡ä»»**ï¼šåŸºäºå¯†ç å­¦å’Œ PDA æœºåˆ¶ï¼Œä¸éœ€è¦ç¬¬ä¸‰æ–¹
2. **åŸå­æ€§**ï¼šäº¤æ˜“è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
3. **çµæ´»æ€§**ï¼šéšæ—¶å¯ä»¥å–æ¶ˆå¹¶å–å›ä»£å¸
4. **å®‰å…¨æ€§**ï¼šå¤šå±‚éªŒè¯ç¡®ä¿èµ„é‡‘å®‰å…¨

### ä¸‰å¤§æ“ä½œå¯¹æ¯”

| æ“ä½œ | è§¦å‘è€… | ç»“æœ | è´¦æˆ·å˜åŒ– |
|------|--------|------|---------|
| **Make** | åˆ›å»ºè€… | åˆ›å»ºæ‰˜ç®¡ | æ‰˜ç®¡è´¦æˆ· + é‡‘åº“è´¦æˆ· |
| **Take** | æ¥å—è€… | å®Œæˆäº¤æ˜“ | æ‰€æœ‰è´¦æˆ·å…³é—­ |
| **Refund** | åˆ›å»ºè€… | å–æ¶ˆäº¤æ˜“ | æ‰€æœ‰è´¦æˆ·å…³é—­ |

### æŠ€æœ¯äº®ç‚¹

- âœ… **PDA æƒé™æ§åˆ¶**ï¼šç¡®ä¿åªæœ‰ç¨‹åºèƒ½æ§åˆ¶é‡‘åº“
- âœ… **has_one çº¦æŸ**ï¼šéªŒè¯è´¦æˆ·åŒ¹é…
- âœ… **åŸå­äº¤æ˜“**ï¼šé˜²æ­¢éƒ¨åˆ†å¤±è´¥
- âœ… **è´¦æˆ·å…³é—­**ï¼šé˜²æ­¢é‡å¤æ“ä½œ
- âœ… **ç§Ÿé‡‘è±å…**ï¼šç¡®ä¿è´¦æˆ·æŒä¹…åŒ–

### é€‚åˆäººç¾¤

è¿™ä¸ªç³»ç»Ÿé€‚åˆï¼š
- ğŸ”¹ æƒ³è¦å­¦ä¹  Solana å¼€å‘çš„å¼€å‘è€…
- ğŸ”¹ ç†è§£ Anchor å’Œ Pinocchio æ¡†æ¶å·®å¼‚çš„å­¦ä¹ è€…
- ğŸ”¹ éœ€è¦ DEX æˆ–äº¤æ˜“åŠŸèƒ½çš„åè®®å¼€å‘è€…
- ğŸ”¹ ç ”ç©¶åŒºå—é“¾å®‰å…¨å’Œå¯†ç å­¦çš„å­¦ç”Ÿ

---

## é™„å½•

### ç›¸å…³æ–‡ä»¶

- **ä¸šåŠ¡é€»è¾‘**ï¼š
  - `src/lib.rs` - ç¨‹åºå…¥å£
  - `src/instructions/make.rs` - åˆ›å»ºæ‰˜ç®¡
  - `src/instructions/take.rs` - æ¥å—æ‰˜ç®¡
  - `src/instructions/refund.rs` - å–æ¶ˆæ‰˜ç®¡

- **æ•°æ®ç»“æ„**ï¼š
  - `src/state.rs` - æ‰˜ç®¡è´¦æˆ·ç»“æ„
  - `src/errors.rs` - é”™è¯¯ç±»å‹

- **è¾…åŠ©å·¥å…·**ï¼š
  - `src/instructions/helpers.rs` - Pinocchio è´¦æˆ·éªŒè¯

### æµ‹è¯•å‘½ä»¤

```bash
# æ„å»ºç¨‹åº
cargo build --release --target wasm32-unknown-unknown

# è¿è¡Œæµ‹è¯•
cargo test

# éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ
solana program deploy target/deploy/blueshift_escrow.so
```

### å‚è€ƒèµ„æ–™

- [Solana å®˜æ–¹æ–‡æ¡£](https://docs.solana.com/)
- [Anchor æ¡†æ¶](https://www.anchor-lang.com/)
- [Pinocchio æ¡†æ¶](https://github.com/cap_prints/pinocchio)
- [SPL Token Program](https://spl.solana.com/token)

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0
**æœ€åæ›´æ–°:** 2026-01-27
**ä½œè€…:** Blueshift Team
